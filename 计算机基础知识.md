# 计算机网络

## 1. 基础篇

## 1.1 TCP/IP网络模型

**应用层、传输层、网络层、网络接口层、物理层。**

#### 传输层

传输层中UDP 也可以实现可靠传输，把 TCP 的特性在应用层上实现就可以，不过这并不简单。

应用需要传输的数据可能会非常大，如果直接传输就不好控制，因此当传输层的数据包大小超过 MSS（TCP 最大报文段长度） ，就要将数据包分块，这样即使中途有一个分块丢失或损坏了，只需要重新发送这一个分块，而不用重新发送整个数据包。在 TCP 协议中，我们把每个分块称为一个 TCP 段（TCP Segment）。

端口用于区分不同的应用。比如 80 端口通常是 Web 服务器用的，22 端口通常是远程登录服务器用的。而对于浏览器（客户端）中的每个标签栏都是一个独立的进程，操作系统会为这些进程分配临时的端口号。

#### 网络层

如果 IP 报文大小超过 MTU（以太网中一般为 1500 字节）就会再次进行分片。

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/12.jpg)

![img](计算机基础知识.assets/封装.png)

## 1.2 键入网址到网页显示，期间发生了什么

**①浏览器第一步解析URL，生成http消息**。

![URL 解析](计算机基础知识.assets/3.jpg)

当没有路径名时，就代表访问根目录下事先设置的**默认文件**，也就是 `/index.html` 或者 `/default.html` 这些文件，这样就不会发生混乱了。

②由于浏览器需要委托操作系统将消息发送给Web服务器，所以必须提供通信对象的IP地址。

DNS服务器负责保存`Web` 服务器域名与 `IP` 的对应关系。

域名的层级关系类似一个树状结构：

- 根 DNS 服务器（.）
- 顶级域 DNS 服务器（.com）
- 权威 DNS 服务器（server.com）

DNS解析过程

![域名解析的工作流程](计算机基础知识.assets/6.jpg)

③通过 DNS 获取到 IP 后，就可以把 HTTP 的传输工作交给操作系统中的协议栈。

协议栈的内部分为几个部分，分别承担不同的工作。上下关系是有一定的规则的，上面的部分会向下面的部分委托工作，下面的部分收到委托的工作并执行。

![img](计算机基础知识.assets/7.jpg)

应用程序（浏览器）通过调用 Socket 库，来委托协议栈工作。协议栈的上半部分有两块，分别是负责收发数据的 TCP 和 UDP 协议，这两个传输协议会接受应用层的委托执行收发数据的操作。

协议栈的下面一半是用 IP 协议控制网络包收发操作，在互联网上传数据时，数据会被切分成一块块的网络包，而将网络包发送给对方的操作就是由 IP 负责的。

此外 IP 中还包括 `ICMP` 协议和 `ARP` 协议。

- `ICMP` 用于告知网络包传送过程中产生的错误以及各种控制信息。
- `ARP` 用于根据 IP 地址查询相应的以太网 MAC 地址。

IP 下面的网卡驱动程序负责控制网卡硬件，而最下面的网卡则负责完成实际的收发操作，也就是对网线中的信号执行发送和接收操作。

**④可靠传输-TCP**

![TCP 包头格式](计算机基础知识.assets/8.jpg)

TCP传输数据之前，要先三次握手建立连接。保证双方都有发送和接收的能力。

在 Linux 可以通过 `netstat -napt` 命令查看TCP连接状态。

TCP 协议里面会有两个端口，一个是浏览器监听的端口（通常是随机生成的），一个是 Web 服务器监听的端口（HTTP 默认端口号是 `80`， HTTPS 默认端口号是 `443`）。

**⑤远程定位-IP**

![IP 包头格式](计算机基础知识.assets/14.jpg)

因为 HTTP 是经过 TCP 传输的，所以在 IP 包头的**协议号**，要填写为 `06`（十六进制），表示协议为 TCP。

在 Linux 操作系统，我们可以使用 `route -n` 命令查看当前系统的路由表。

![路由规则判断](计算机基础知识.assets/16.jpg)

第三条目比较特殊，它目标地址和子网掩码都是 `0.0.0.0`，这表示**默认网关**，如果其他所有条目都无法匹配，就会自动匹配这一行。并且后续就把包发给路由器，`Gateway` 即是路由器的 IP 地址。